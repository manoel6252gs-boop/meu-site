<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CHARLES PLAYBACK - PRO</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { 
            --primary: #fff159; 
            --primary-dark: #d4c63b;
            --accent: #3483fa; 
            --success: #00a650; 
            --danger: #ff4747; 
            --bg: #0a0a0a; 
            --card-bg: #161616; 
            --text: #ffffff;
            --text-dim: #a0a0a0;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background-color: #000; 
            display: flex; 
            justify-content: center; 
            min-height: 100vh; 
            color: var(--text);
            overflow-x: hidden;
        }

        .app-shell { 
            width: 100%; 
            max-width: 100%; 
            background: var(--bg); 
            min-height: 100vh; 
            display: flex; 
            flex-direction: column;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }

        @media (min-width: 768px) {
            .app-shell { max-width: 1200px; margin: 0 auto; }
            .nav-tabs { max-width: 1200px !important; left: 50% !important; transform: translateX(-50%); }
        }

        header { 
            background: rgba(10, 10, 10, 0.8);
            backdrop-filter: blur(10px);
            padding: 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            position: sticky; 
            top: 0; 
            z-index: 100;
            border-bottom: 1px solid #222;
        }

        .logo { 
            font-family: 'Orbitron', sans-serif; 
            font-size: 20px; 
            color: var(--primary); 
            letter-spacing: 1px;
            text-shadow: 0 0 10px rgba(255, 241, 89, 0.3);
        }

        .user-tag { 
            background: #222; 
            padding: 6px 14px; 
            border-radius: 30px; 
            font-size: 10px; 
            font-weight: 800;
            text-transform: uppercase;
            border: 1px solid #333;
            color: var(--primary);
        }

        .nav-tabs { 
            display: flex; 
            background: rgba(18, 18, 18, 0.9); 
            backdrop-filter: blur(15px);
            position: fixed; 
            bottom: 0; 
            width: 100%; 
            z-index: 99; 
            border-top: 1px solid #333;
            padding: 8px 0 12px 0;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.8);
        }

        .tab-btn { 
            flex: 1; 
            padding: 10px 0; 
            text-align: center; 
            font-size: 10px; 
            font-weight: 700; 
            color: var(--text-dim); 
            cursor: pointer; 
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            gap: 4px;
            position: relative;
        }

        .tab-btn span:first-child {
            font-size: 18px;
            transition: transform 0.3s;
        }

        .tab-btn.active { 
            color: var(--primary); 
        }

        .tab-btn.active span:first-child {
            transform: translateY(-3px) scale(1.2);
            filter: drop-shadow(0 0 8px var(--primary));
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 3px;
            background: var(--primary);
            border-radius: 10px;
            box-shadow: 0 0 10px var(--primary);
        }

        .tab-btn:active {
            transform: scale(0.9);
        }

        .main-content { padding: 15px; flex-grow: 1; padding-bottom: 100px; }
        .page { display: none; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card { 
            background: var(--card-bg); 
            border-radius: 20px; 
            padding: 20px; 
            margin-bottom: 15px; 
            border: 1px solid #252525;
        }

        .prod-card { 
            background: var(--card-bg); 
            border-radius: 24px; 
            overflow: hidden; 
            margin-bottom: 25px; 
            border: 1px solid #222;
            transition: transform 0.2s;
        }

        .prod-card img { width: 100%; height: 220px; object-fit: cover; }
        .prod-info { padding: 20px; }
        .prod-info h3 { font-size: 18px; margin-bottom: 2px; font-weight: 700; }
        .author-tag { color: #888; font-size: 11px; margin-bottom: 12px; display: block; }
        .price { color: var(--primary); font-size: 24px; font-weight: 800; margin-bottom: 15px; display: block; }

        .vitrine-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .filter-container {
            margin-bottom: 20px;
            display: flex;
            justify-content: flex-end;
        }
        
        .filter-select {
            background: #111;
            color: var(--primary);
            border: 1px solid #333;
            padding: 8px 12px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 700;
            outline: none;
        }

        .social-link {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #000;
            padding: 12px;
            border-radius: 12px;
            text-decoration: none;
            color: #fff;
            margin-bottom: 10px;
            border: 1px solid #333;
            font-size: 14px;
            font-weight: 600;
        }

        .footer-credits {
            text-align: center;
            font-size: 11px;
            color: #555;
            margin-top: 30px;
            padding: 20px;
            line-height: 1.5;
        }

        input { 
            width: 100%; padding: 16px; margin-bottom: 12px; border: 1px solid #333; 
            border-radius: 14px; background: #000; color: #fff; font-size: 14px;
        }

        button { 
            width: 100%; padding: 16px; border: none; border-radius: 14px; 
            font-weight: 800; cursor: pointer; transition: 0.2s; font-size: 14px;
            text-transform: uppercase; letter-spacing: 0.5px;
        }

        .btn-primary { background: var(--primary); color: #000; }
        .btn-success { background: var(--success); color: #fff; }
        .btn-outline { background: rgba(255,255,255,0.05); border: 1px solid #333; color: #fff; margin-top: 10px; }

        audio { 
            width: 100%; height: 40px; margin: 15px 0; border-radius: 30px;
            filter: invert(100%) hue-rotate(180deg) brightness(1.5);
        }

        .status-blink { color: var(--primary); font-weight: 800; animation: blink 1s infinite; font-size: 12px; }
        @keyframes blink { 50% { opacity: 0.4; } }

        .admin-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 15px; }
        .admin-table th { color: var(--text-dim); text-align: left; padding: 10px; border-bottom: 1px solid #333; }
        .admin-table td { padding: 12px 10px; border-bottom: 1px solid #222; }

        .url-output { 
            background: #000 !important; color: var(--primary) !important; 
            font-family: 'Courier New', monospace; font-size: 11px; 
            margin-top: 10px; border: 1px dotted var(--primary); 
        }
    </style>
</head>
<body>

<div class="app-shell">
    <header>
        <div class="logo">CHARLES PRO</div>
        <div id="user-display" class="user-tag">Visitante</div>
    </header>

    <div class="main-content">
        <div id="page-loja" class="page active">
            <div class="filter-container">
                <select class="filter-select" onchange="renderL(this.value)">
                    <option value="desc">Mais Recentes</option>
                    <option value="asc">Mais Antigos</option>
                </select>
            </div>
            <div id="vitrine" class="vitrine-grid"></div>
        </div>

        <div id="page-carrinho" class="page">
            <div class="card">
                <h2 style="margin-bottom:20px">Meu Carrinho</h2>
                <div id="lista-carrinho"></div>
                <div id="carrinho-total" style="font-size: 28px; color: var(--primary); font-weight: 900; margin: 20px 0; border-top: 1px solid #333; padding-top: 20px;"></div>
                
                <div style="background: rgba(255, 241, 89, 0.05); padding: 20px; border-radius: 20px; margin-bottom: 20px; border: 1px solid #333; text-align: center;">
                    <small style="color: var(--primary); font-weight: 700; display: block; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px;">Escaneie o QR Code para Pagar</small>
                    
                    <div style="background: #fff; padding: 10px; border-radius: 12px; display: inline-block; margin-bottom: 15px;">
                        <img src="https://yhwifmxfaqjsllqzvxkq.supabase.co/storage/v1/object/sign/playbacks/capas/1769011775840_1000898667.jpg?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV83N2I5M2JkNS1iMGJjLTQ4MzQtYThmZC01NzYxYzlhYmJlMjgiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJwbGF5YmFja3MvY2FwYXMvMTc2OTAxMTc3NTg0MF8xMDAwODk4NjY3LmpwZyIsImlhdCI6MTc2OTAxMTc3NywiZXhwIjoyMDg0MzcxNzc3fQ.bqhZeuMsKZs6z7zjvy-8LGJTD0LSr7UVkyXVRUnjnYs" 
                             alt="QR Code Pix" style="width: 200px; height: 200px; display: block;">
                    </div>

                    <div style="border-top: 1px solid #222; margin-top: 10px; padding-top: 15px;">
                        <code style="font-size: 10px; font-weight: 700; color: #666; word-break: break-all; background: #000; padding: 10px; border-radius: 8px; display: block; border: 1px solid #222; margin-bottom: 10px;">00020101021126580014br.gov.bcb.pix01362557c638-b96a-4c51-a170-9690a4d750615204000053039865802BR5915CHARLES A BRAGA6007MUCAMBO62070503***63048CB7</code>
                        <button class="btn-primary" style="height: auto; padding: 14px;" onclick="copyPix()">COPIAR E COLAR</button>
                    </div>
                </div>

                <label style="font-size: 12px; color: #888; margin-bottom: 8px; display: block;">Anexe o comprovante (Foto):</label>
                <input type="file" id="comprovante-file" accept="image/*">
                <button id="btn-enviar-comp" class="btn-success" onclick="enviarComprovante()">Finalizar Pedido</button>
            </div>
        </div>

        <div id="page-conta" class="page">
            <div id="auth-box" class="card" style="margin-top: 20px; max-width: 400px; margin-left: auto; margin-right: auto;">
                <h3 style="margin-bottom: 20px; text-align: center;">Bem-vindo</h3>
                <input type="email" id="auth-email" placeholder="Seu e-mail">
                <input type="password" id="auth-password" placeholder="Sua senha">
                
                <div id="login-actions">
                    <button class="btn-primary" onclick="handleLogin()">Entrar agora</button>
                    <button class="btn-outline" onclick="toggleAuthMode(true)">N√£o tenho conta</button>
                </div>
                
                <div id="signup-actions" style="display:none;">
                    <button class="btn-success" onclick="handleSignUp()">Criar minha conta</button>
                    <button class="btn-outline" onclick="toggleAuthMode(false)">J√° sou cliente</button>
                </div>
            </div>

            <div id="profile-box" style="display:none; max-width: 400px; margin-left: auto; margin-right: auto;">
                <div class="card" style="text-align: center;">
                    <div style="width: 70px; height: 70px; background: var(--primary); border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; color: #000; font-size: 26px; font-weight: 900;">C</div>
                    <h3 id="profile-email" style="margin-bottom: 20px; color: var(--text-dim); font-size: 14px;"></h3>
                    <button id="btn-acesso-admin" class="btn-primary" style="margin-bottom:10px; background: var(--danger); color: white;" onclick="verificarAdmin()">Painel de Controle</button>
                    <button class="btn-outline" onclick="handleLogout()">Sair da Conta</button>
                </div>

                <div class="card">
                    <h4 style="margin-bottom: 15px; font-size: 14px; text-transform: uppercase; color: var(--primary);">Nossas Redes</h4>
                    <a href="https://www.youtube.com/@CharlesTeclas" target="_blank" class="social-link">
                        <span style="color: #ff0000; font-size: 18px;">‚ñ∂</span> YouTube: Charles Teclas
                    </a>
                    <a href="https://www.instagram.com/Charles_teclas1" target="_blank" class="social-link">
                        <span style="background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 18px;">‚óè</span> Instagram: Charles_teclas1
                    </a>
                </div>

                <div class="footer-credits">
                    ¬© 2026 ‚Äì Todos os direitos reservados a<br>
                    <strong>Charles teclas no Beat</strong>
                </div>
            </div>
        </div>

        <div id="page-downloads" class="page">
            <h2 style="margin: 0 0 20px 5px;">Meus Playbacks</h2>
            <div id="downloads-list" class="vitrine-grid"></div>
        </div>

        <div id="page-admin" class="page">
            <div class="card">
                <button class="btn-outline" style="margin-bottom: 20px;" onclick="showPage('conta')">‚¨Ö Sair do Admin</button>
                <h3>Pedidos Pendentes</h3>
                <table class="admin-table">
                    <thead><tr><th>Cliente</th><th>Provante</th><th>A√ß√£o</th></tr></thead>
                    <tbody id="corpo-tabela-admin"></tbody>
                </table>
            </div>
            
            <div class="card">
                <h4>Cadastrar Novo Playback (Upload Individual)</h4>
                
                <div style="margin-top:15px; padding: 10px; border: 1px solid #333; border-radius: 12px;">
                    <label style="font-size: 11px; color: var(--text-dim); display: block; margin-bottom: 5px;">1. Capa do √Ålbum:</label>
                    <input type="file" id="up-capa" accept="image/*">
                    <button class="btn-primary" id="btn-upload-capa" onclick="uploadIndividual('capa')">Subir Capa</button>
                    <input type="text" id="out-capa" class="url-output" readonly placeholder="Link da Capa">
                </div>

                <div style="margin-top:15px; padding: 10px; border: 1px solid #333; border-radius: 12px;">
                    <label style="font-size: 11px; color: var(--text-dim); display: block; margin-bottom: 5px;">2. Arquivo de √Åudio:</label>
                    <input type="file" id="up-audio" accept="audio/*">
                    <button class="btn-primary" id="btn-upload-audio" onclick="uploadIndividual('audio')" style="background: #3483fa; color: white;">Subir √Åudio</button>
                    <input type="text" id="out-audio" class="url-output" readonly placeholder="Link do √Åudio">
                </div>
            </div>
        </div>
    </div>

    <nav class="nav-tabs">
        <div id="tab-loja" class="tab-btn active" onclick="showPage('loja')"><span>üè†</span>IN√çCIO</div>
        <div id="tab-carrinho" class="tab-btn" onclick="showPage('carrinho')"><span>üõí</span>CARRINHO</div>
        <div id="tab-downloads" class="tab-btn" onclick="showPage('downloads')"><span>üî•</span>PLAYBACKS</div>
        <div id="tab-conta" class="tab-btn" onclick="showPage('conta')"><span>üë§</span>PERFIL</div>
    </nav>
</div>

<script>
    const SB_URL = 'https://yhwifmxfaqjsllqzvxkq.supabase.co';
    const SB_KEY = 'sb_publishable_S9gOQ0dXOn8GHD6eW2dTTQ_cFNO29o9';
    const _supabase = supabase.createClient(SB_URL, SB_KEY);

    let currentUser = null, carrinho = JSON.parse(localStorage.getItem('MP_CART')) || [];

    async function init() {
        const { data: { session } } = await _supabase.auth.getSession();
        if(session) updateUserStatus(session.user);
        renderL(); 
        updateCartUI();
    }

    async function verificarAdmin() {
        if (!currentUser) { alert("Fa√ßa login primeiro."); return; }
        const { data } = await _supabase.from('profiles').select('is_admin').eq('id', currentUser.id).single();
        if (data && data.is_admin === true) { showPage('admin'); } else { alert("Voc√™ n√£o √© um Admin"); }
    }

    function copyPix() {
        const fullKey = "00020101021126580014br.gov.bcb.pix01362557c638-b96a-4c51-a170-9690a4d750615204000053039865802BR5915CHARLES A BRAGA6007MUCAMBO62070503***63048CB7";
        navigator.clipboard.writeText(fullKey).then(() => {
            alert("‚úÖ Copiado!");
        }).catch(err => {
            const tempInput = document.createElement("input");
            tempInput.value = fullKey;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand("copy");
            document.body.removeChild(tempInput);
            alert("‚úÖ Copiado!");
        });
    }

    function showPage(p) {
        document.querySelectorAll('.page').forEach(x => x.classList.remove('active'));
        const targetPage = document.getElementById('page-' + p);
        if(targetPage) targetPage.classList.add('active');
        document.querySelectorAll('.tab-btn').forEach(x => x.classList.remove('active'));
        const targetTab = document.getElementById('tab-' + p);
        if(targetTab) targetTab.classList.add('active');
        if(p === 'admin') carregarPedidosAdmin();
        if(p === 'downloads') renderDownloads();
        window.scrollTo(0,0);
    }

    function toggleAuthMode(s) {
        document.getElementById('login-actions').style.display = s ? 'none' : 'block';
        document.getElementById('signup-actions').style.display = s ? 'block' : 'none';
    }

    async function updateUserStatus(user) {
        currentUser = user;
        const display = document.getElementById('user-display'), authBox = document.getElementById('auth-box'), profileBox = document.getElementById('profile-box');
        if (user) {
            display.innerText = user.email.split('@')[0];
            authBox.style.display = 'none'; profileBox.style.display = 'block';
            document.getElementById('profile-email').innerText = user.email;
        } else {
            display.innerText = "Visitante"; authBox.style.display = 'block'; profileBox.style.display = 'none';
        }
    }

    async function handleLogin() {
        const e = document.getElementById('auth-email').value, s = document.getElementById('auth-password').value;
        const { data, error } = await _supabase.auth.signInWithPassword({ email: e, password: s });
        if (error) alert(error.message); else { updateUserStatus(data.user); showPage('loja'); renderL(); }
    }

    async function handleSignUp() {
        const e = document.getElementById('auth-email').value, s = document.getElementById('auth-password').value;
        const { error } = await _supabase.auth.signUp({ email: e, password: s });
        if (error) alert(error.message); else alert("Conta criada!");
    }

    async function handleLogout() {
        await _supabase.auth.signOut();
        currentUser = null; updateUserStatus(null); showPage('loja'); renderL();
    }

    function pararOutrosAudios(audioAtual) {
        document.querySelectorAll('audio').forEach(audio => { if (audio !== audioAtual) { audio.pause(); audio.currentTime = 0; } });
    }

    async function renderL(ordem = 'desc') {
        const { data } = await _supabase.from('musicas').select('*').order('id', { ascending: ordem === 'asc' });
        if(data) {
            document.getElementById('vitrine').innerHTML = data.map(p => `
                <div class="prod-card">
                    <img src="${p.imagen_u || p.Imagen_u}">
                    <div class="prod-info">
                        <h3>${p.nome || p.Nome}</h3>
                        <span class="author-tag">Publicado por Charles teclas no Beat</span>
                        <span class="price">R$ ${parseFloat(p.pre√ßo || p.Pre√ßo).toFixed(2)}</span>
                        <audio controls onplay="pararOutrosAudios(this)" src="${p.Audio_url}"></audio>
                        <button class="btn-primary" onclick="addCarrinho(${p.id}, '${p.nome || p.Nome}', ${p.pre√ßo || p.Pre√ßo})">Adicionar ao Carrinho</button>
                    </div>
                </div>`).join('');
        }
    }

    function addCarrinho(id, nome, preco) {
        if(!currentUser) return showPage('conta');
        carrinho.push({ id, nome, preco, tempId: Date.now() });
        localStorage.setItem('MP_CART', JSON.stringify(carrinho));
        updateCartUI(); showPage('carrinho');
    }

    function updateCartUI() {
        const lista = document.getElementById('lista-carrinho');
        if(carrinho.length === 0) {
            lista.innerHTML = "<p style='color:#888; text-align:center; padding:30px;'>O carrinho est√° vazio</p>";
        } else {
            lista.innerHTML = carrinho.map(i => `
                <div style="display:flex; justify-content:space-between; align-items:center; background:#000; padding:15px; border-radius:12px; margin-bottom:10px; border: 1px solid #222;">
                    <div style="display:flex; flex-direction:column; gap:2px;">
                        <span style="font-weight:700; font-size:14px;">${i.nome}</span>
                        <span style="color:var(--primary); font-size:12px; font-weight:600;">R$ ${parseFloat(i.preco).toFixed(2)}</span>
                    </div>
                    <button onclick="removerItem(${i.tempId})" style="width:36px; height:36px; padding:0; background:rgba(255,0,0,0.1); color:red; border-radius:10px; font-weight:bold; border: 1px solid rgba(255,0,0,0.2);">‚úï</button>
                </div>`).join('');
        }
        document.getElementById('carrinho-total').innerText = "Total: R$ " + carrinho.reduce((a,b)=>a+b.preco,0).toFixed(2);
    }

    function removerItem(t) { carrinho = carrinho.filter(i => i.tempId !== t); localStorage.setItem('MP_CART', JSON.stringify(carrinho)); updateCartUI(); }

    async function enviarComprovante() {
        const file = document.getElementById('comprovante-file').files[0];
        if(!file || carrinho.length === 0) return alert("Adicione o comprovante e itens no carrinho!");
        const btn = document.getElementById('btn-enviar-comp');
        btn.disabled = true; btn.innerText = "Processando...";
        try {
            const fileName = `${Date.now()}_comp.jpg`;
            await _supabase.storage.from('comprovantes').upload(fileName, file); 
            const { data: urlRes } = _supabase.storage.from('comprovantes').getPublicUrl(fileName);
            await _supabase.from('pedidos').insert([{ 
                usuario: currentUser.email, usuario_id: currentUser.id, 
                items: JSON.stringify(carrinho), comprovante_url: urlRes.publicUrl, status: 'pendente' 
            }]);
            alert("Pedido enviado!");
            carrinho = []; localStorage.removeItem('MP_CART'); updateCartUI(); showPage('loja'); 
        } catch (e) { alert("Erro ao enviar."); } finally { btn.disabled = false; btn.innerText = "Finalizar Pedido"; }
    }

    async function renderDownloads() {
        if(!currentUser) return;
        const { data: pedidos } = await _supabase.from('pedidos').select('*').eq('usuario_id', currentUser.id);
        const container = document.getElementById('downloads-list'); container.innerHTML = "";
        pedidos?.forEach(p => {
            JSON.parse(p.items).forEach(item => {
                let acao = p.status === 'aprovado' ? `<button class="btn-success" style="margin-top:10px" onclick="gerarLinkAssinado(${item.id})">BAIXAR</button>` : `<div style="margin-top:10px" class="status-blink">PENDENTE</div>`;
                container.innerHTML += `<div class="card" style="border-left: 4px solid ${p.status === 'aprovado' ? 'var(--success)' : 'var(--primary)'}"><strong>${item.nome}</strong><br>${acao}</div>`;
            });
        });
    }

    // --- FUN√á√ÉO CORRIGIDA PARA BUSCAR NA PASTA 'AUDIOS' ---
    async function gerarLinkAssinado(musicaId) {
        // Busca a informa√ß√£o no banco
        const { data: m, error: dbError } = await _supabase.from('musicas')
            .select('audio_completo')
            .eq('id', musicaId)
            .single();

        if (dbError || !m.audio_completo) {
            return alert("Link do √°udio n√£o encontrado no cadastro desta m√∫sica!");
        }

        // Tenta extrair o caminho relativo (Ex: 'audios/nome.mp3')
        // Se o link contiver 'playbacks/', pegamos tudo o que vem depois
        let caminhoArquivo = m.audio_completo;
        if (caminhoArquivo.includes('playbacks/')) {
            caminhoArquivo = caminhoArquivo.split('playbacks/').pop();
        } else {
            // Caso seja apenas o nome do arquivo, garantimos que ele pegue da raiz
            caminhoArquivo = caminhoArquivo.split('/').pop();
        }

        // Gera o link assinado no bucket 'playbacks'
        const { data, error } = await _supabase.storage
            .from('playbacks')
            .createSignedUrl(caminhoArquivo, 60);

        if (error) {
            console.error(error);
            return alert("Erro ao gerar link de download!");
        }

        window.open(data.signedUrl, '_blank');
    }

    async function carregarPedidosAdmin() {
        const { data } = await _supabase.from('pedidos').select('*').eq('status', 'pendente');
        document.getElementById('corpo-tabela-admin').innerHTML = data?.map(p => `<tr><td>${p.usuario.split('@')[0]}</td><td><button style="padding:5px;" onclick="window.open('${p.comprovante_url}', '_blank')">VER</button></td><td><button class="btn-success" style="padding:5px;" onclick="adminAprovarPedido(${p.id})">OK</button></td></tr>`).join('') || "<tr><td>Vazio</td></tr>";
    }

    async function adminAprovarPedido(id) { await _supabase.from('pedidos').update({ status: 'aprovado' }).eq( 'id', id); alert("Aprovado!"); carregarPedidosAdmin(); }

    async function uploadIndividual(tipo) {
        const fileInput = tipo === 'capa' ? document.getElementById('up-capa') : document.getElementById('up-audio');
        const btn = tipo === 'capa' ? document.getElementById('btn-upload-capa') : document.getElementById('btn-upload-audio');
        const output = tipo === 'capa' ? document.getElementById('out-capa') : document.getElementById('out-audio');
        
        const file = fileInput.files[0];
        if (!file) return alert("Selecione o arquivo primeiro!");

        btn.innerText = "Subindo...";
        btn.disabled = true;

        try {
            const pasta = tipo === 'capa' ? 'capas' : 'audios';
            const nomeArquivo = `${Date.now()}_${file.name.replace(/\s/g, '_')}`;
            const caminhoCompleto = `${pasta}/${nomeArquivo}`;

            // Upload para o storage
            const { error: uploadError } = await _supabase.storage
                .from('playbacks')
                .upload(caminhoCompleto, file);

            if (uploadError) throw uploadError;

            // Gera URL p√∫blica direta (n√£o expira)
            const { data } = _supabase.storage
                .from('playbacks')
                .getPublicUrl(caminhoCompleto);

            if (data.publicUrl) {
                output.value = data.publicUrl;
                alert(`${tipo.toUpperCase()} enviado com sucesso!`);
            }

        } catch (error) {
            alert("Erro: " + error.message);
        } finally {
            btn.innerText = tipo === 'capa' ? "Subir Capa" : "Subir √Åudio";
            btn.disabled = false;
        }
    }

    init();
</script>
</body>
</html>
