<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CHARLES PLAYBACK - PRO</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: #000; display: flex; justify-content: center; min-height: 100vh; color: #fff; }
        .app-shell { width: 100%; max-width: 450px; background: #121212; min-height: 100vh; display: flex; flex-direction: column; position: relative; }
        
        /* ESTILO DO BOT√ÉO INVIS√çVEL */
        #meuBotaoAdmin {
            opacity: 0;
            width: 80px;
            height: 50px;
            border: none;
            cursor: default;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 10000;
        }

        header { 
            background: #fff159; 
            padding: 12px 15px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            position: sticky; 
            top: 0; 
            z-index: 100; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .logo { 
            font-family: 'Orbitron', sans-serif; 
            font-weight: 900; 
            font-size: 18px; 
            color: #000; 
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .header-controls { display: flex; align-items: center; gap: 5px; }
        .user-tag { background: #333; padding: 5px 10px; border-radius: 20px; font-size: 10px; font-weight: bold; color: #fff; }
        .btn-admin-top { display: none; background: #ff0000; color: white; padding: 6px 12px; border-radius: 20px; font-size: 10px; font-weight: 900; cursor: pointer; border: none; }
        
        .nav-tabs { display: flex; background: #1e1e1e; position: sticky; top: 52px; z-index: 99; border-bottom: 1px solid #333; }
        .tab-btn { flex: 1; padding: 15px 0; text-align: center; font-size: 11px; font-weight: bold; color: #888; cursor: pointer; border-bottom: 3px solid transparent; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .tab-btn.active { color: #fff; border-bottom: 3px solid #fff159; }
        
        .main-content { padding: 20px 15px; flex-grow: 1; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .card { background: #1e1e1e; border-radius: 15px; padding: 20px; margin-bottom: 15px; border: 1px solid #2a2a2a; }
        input { width: 100%; padding: 14px; margin-bottom: 15px; border: 1px solid #333; border-radius: 10px; background: #252525; color: #fff; }
        button { width: 100%; padding: 15px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 14px; text-transform: uppercase; }
        .btn-primary { background: #3483fa; color: #fff; }
        .btn-success { background: #00a650; color: #fff; }
        
        .prod-card { background: #1e1e1e; border-radius: 15px; overflow: hidden; margin-bottom: 20px; border: 1px solid #333; }
        .prod-card img { width: 100%; height: 200px; object-fit: cover; }
        .prod-info { padding: 15px; }
        .prod-price { color: #fff159; font-size: 20px; font-weight: bold; margin: 10px 0; }

        audio { 
            width: 100%; 
            height: 40px; 
            margin: 10px 0; 
            border-radius: 30px; 
            background: #fff; 
        }

        audio::-webkit-media-controls-slider-thumb {
            background-color: #ff0000 !important;
            border: 0;
        }
        
        .pix-destaque { background: #252525; padding: 20px; border-radius: 15px; text-align: center; border: 2px solid #fff159; margin: 15px 0; }
        .pix-qrcode { width: 200px; height: 200px; border-radius: 10px; margin-bottom: 15px; }
        .btn-copiar-pix { 
            background: #fff159; 
            color: #000; 
            padding: 10px; 
            border-radius: 8px; 
            font-size: 14px; 
            font-weight: 900; 
            margin-top: 10px; 
            cursor: pointer; 
            display: inline-block;
            width: 100%;
        }

        .timer-box { font-size: 22px; color: #ff4747; text-align: center; font-weight: bold; margin: 10px 0; }
        .url-output { background: #000 !important; color: #fff159 !important; font-family: monospace; font-size: 10px; margin-top: 5px; cursor: pointer; border: 1px solid #444; }
        .admin-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 15px; color: white; }
        .admin-table th, .admin-table td { border: 1px solid #333; padding: 8px; text-align: left; }

        .status-blink {
            color: #fff159;
            font-weight: 900;
            font-size: 11px;
            text-transform: uppercase;
            animation: blink 1s linear infinite;
        }
        @keyframes blink { 50% { opacity: 0; } }
    </style>
</head>
<body>

<button id="meuBotaoAdmin"></button>

<div class="app-shell">
    <header>
        <div class="logo">Charles Playback</div>
        <div class="header-controls">
            <div id="user-display" class="user-tag">Visitante</div>
            <button class="btn-admin-top" onclick="accessAdmin()">ADMIN</button>
        </div>
    </header>

    <nav class="nav-tabs">
        <div class="tab-btn active" id="tab-loja" onclick="showPage('loja', this)"><span>üõçÔ∏è</span> Loja</div>
        <div class="tab-btn" id="tab-carrinho" onclick="showPage('carrinho', this)"><span>üõí</span> Carrinho</div>
        <div class="tab-btn" id="tab-conta" onclick="showPage('conta', this)"><span>üë§</span> Conta</div>
        <div class="tab-btn" id="tab-downloads" onclick="showPage('downloads', this)"><span>üì•</span> Baixar</div>
    </nav>

    <div class="main-content">
        <div id="page-loja" class="page active"><div id="vitrine"></div></div>

        <div id="page-carrinho" class="page">
            <div class="card">
                <h3>Resumo do Pedido</h3>
                <div id="carrinho-vazio">Seu carrinho est√° vazio.</div>
                <div id="carrinho-info" style="display:none;">
                    <div id="lista-carrinho"></div>
                    <div class="total-box" id="carrinho-total" style="font-size: 20px; font-weight: 900; text-align: right; margin: 15px 0; color: #fff159;">Total: R$ 0,00</div>
                    
                    <div class="pix-destaque">
                        <p style="font-size: 12px; margin-bottom: 10px; color: #fff;">Escaneie o QR Code para pagar:</p>
                        <img src="https://yhwifmxfaqjsllqzvxkq.supabase.co/storage/v1/object/public/playbacks/1768395681037.jpg" class="pix-qrcode">
                        
                        <div style="margin-top: 10px; border-top: 1px solid #444; padding-top: 10px;">
                            <small>Ou copie a chave Pix:</small><br>
                            <button class="btn-copiar-pix" onclick="copiarChavePix('88994387701')">
                                üìã COPIAR CHAVE: 88994387701
                            </button>
                        </div>
                    </div>

                    <div class="timer-box" id="pix-timer">30:00</div>
                    <p style="font-size:11px; margin-bottom:5px;">Anexe seu comprovante:</p>
                    <input type="file" id="comprovante-file" accept="image/*">
                    <button class="btn-success" onclick="enviarComprovanteParaSupabase()">ENVIAR COMPROVANTE</button>
                    <button style="background:transparent; color:#ff4747; margin-top:10px;" onclick="limparCarrinho()">Esvaziar Carrinho</button>
                </div>
            </div>
        </div>

        <div id="page-conta" class="page">
            <div id="auth-box" class="card">
                <h3>Acessar Conta</h3>
                <input type="text" id="log-u" placeholder="Usu√°rio">
                <input type="password" id="log-p" placeholder="Senha">
                <button class="btn-primary" onclick="login()">ENTRAR</button>
                <button class="btn-success" style="margin-top:10px" onclick="register()">CRIAR CONTA</button>
            </div>
            <div id="profile-box" class="card" style="display:none; text-align:center">
                <p id="profile-reg" style="font-size:12px; color:#aaa; margin-bottom:5px"></p>
                <h2 id="profile-name" style="margin-bottom:20px;"></h2>
                <button style="background:#333; color:#ff4747;" onclick="logout()">SAIR DA CONTA</button>
            </div>
        </div>

        <div id="page-downloads" class="page">
            <div id="downloads-list">
                <p style="text-align:center; color:#666;">Fa√ßa login para ver seus arquivos.</p>
            </div>
        </div>

        <div id="page-admin" class="page">
            <div class="card" style="border: 1px solid #fff159;">
                <h4 style="color:#fff159; margin-bottom:15px;">Aprovar Pedidos Pendentes</h4>
                <table class="admin-table">
                    <thead><tr><th>Cliente</th><th>Foto</th><th>A√ß√£o</th></tr></thead>
                    <tbody id="corpo-tabela-admin"></tbody>
                </table>
                <hr style="margin: 20px 0; border: 0; border-top: 1px solid #333;">
                <h4 style="color:#fff159; margin-bottom:15px;">Painel de Upload Supabase</h4>
                <div style="margin-bottom: 25px;">
                    <label style="font-size:11px; color:#fff159; font-weight:bold;">SUBIR CAPA (IMAGEM):</label>
                    <input type="file" id="up-img-file" accept="image/*" style="margin-top:5px;">
                    <button class="btn-primary" onclick="gerarLink('up-img-file', 'res-img-url')">GERAR URL DA CAPA</button>
                    <input type="text" id="res-img-url" class="url-output" readonly placeholder="Link da imagem..." onclick="copy(this)">
                </div>
                <div style="margin-bottom: 10px;">
                    <label style="font-size:11px; color:#fff159; font-weight:bold;">SUBIR PLAYBACK (√ÅUDIO):</label>
                    <input type="file" id="up-audio-file" accept="audio/*" style="margin-top:5px;">
                    <button class="btn-primary" onclick="gerarLink('up-audio-file', 'res-audio-url')">GERAR URL DO √ÅUDIO</button>
                    <input type="text" id="res-audio-url" class="url-output" readonly placeholder="Link do √°udio..." onclick="copy(this)">
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const _supabase = supabase.createClient('https://yhwifmxfaqjsllqzvxkq.supabase.co', 'sb_publishable_S9gOQ0dXOn8GHD6eW2dTTQ_cFNO29o9');
    let db, session = JSON.parse(localStorage.getItem('MP_SES')) || null, carrinho = JSON.parse(localStorage.getItem('MP_CART')) || [], intervalTimer;

    const request = indexedDB.open("MercadoPlaybackDB", 2);
    request.onsuccess = e => { db = e.target.result; renderL(); renderDownloads(); updateCartUI(); };
    request.onupgradeneeded = e => {
        db = e.target.result;
        if(!db.objectStoreNames.contains("usuarios")) db.createObjectStore("usuarios", { keyPath: "u" });
    };

    function copiarChavePix(chave) {
        navigator.clipboard.writeText(chave).then(() => {
            alert("Chave Pix copiada: " + chave);
        }).catch(err => {
            const temp = document.createElement('input');
            temp.value = chave;
            document.body.appendChild(temp);
            temp.select();
            document.execCommand('copy');
            document.body.removeChild(temp);
            alert("Chave Pix copiada!");
        });
    }

    async function renderL() {
        const { data } = await _supabase.from('musicas').select('*').order('id', { ascending: false });
        const v = document.getElementById('vitrine'); v.innerHTML = "";
        data?.forEach(p => {
            const urlAudio = p.Audio_url || p.audio_url || p.audio_completo;
            v.innerHTML += `
            <div class="prod-card">
                <img src="${p.Imagen_u || p.imagen_u}">
                <div class="prod-info">
                    <h3>${p.Nome || p.nome}</h3>
                    <p class="prod-price">R$ ${parseFloat(p.Pre√ßo || 0).toFixed(2)}</p>
                    <audio controls controlsList="nodownload" preload="auto">
                        <source src="${urlAudio}" type="audio/mpeg">
                    </audio>
                    <button class="btn-primary" onclick="addCarrinho(${p.id}, '${p.Nome}', ${p.Pre√ßo})">COMPRAR</button>
                </div>
            </div>`;
        });
    }

    async function renderDownloads() {
        if(!session) return;
        document.getElementById('user-display').innerText = session.u;
        document.getElementById('auth-box').style.display = 'none';
        document.getElementById('profile-box').style.display = 'block';
        document.getElementById('profile-name').innerText = session.u;
        document.getElementById('profile-reg').innerText = "ID: #" + session.id;
        
        const { data: ped } = await _supabase.from('pedidos').select('*').eq('usuario_id', session.id.toString());
        const { data: mus } = await _supabase.from('musicas').select('*');
        const box = document.getElementById('downloads-list');
        box.innerHTML = "<h4>Seus Downloads:</h4>";
        
        if(ped?.length > 0) {
            ped.forEach(p => JSON.parse(p.items).forEach(item => {
                const m = mus.find(x => x.id == item.id);
                const linkFinal = m?.audio_completo || m?.Audio_url || m?.audio_url;
                
                let conteudoAcao = "";
                if(p.status === 'aprovado') {
                    conteudoAcao = `<a href="${linkFinal}" target="_blank" style="background:#00a650; color:white; padding:10px; border-radius:8px; text-decoration:none; font-size:12px; font-weight:bold;">BAIXAR</a>`;
                } else {
                    conteudoAcao = `<span class="status-blink">‚ö†Ô∏è AGUARDANDO APROVA√á√ÉO</span>`;
                }

                box.innerHTML += `<div class="card" style="display:flex; justify-content:space-between; align-items:center; border-left:5px solid ${p.status === 'aprovado' ? '#00a650' : '#fff159'};">
                    <span style="font-size:13px;">${item.nome}</span>
                    ${conteudoAcao}
                </div>`;
            }));
        } else {
            box.innerHTML = "<p style='text-align:center; color:#666;'>Nenhum arquivo encontrado.</p>";
        }
    }

    async function enviarComprovanteParaSupabase() {
        if(!session) return alert("Logue primeiro!");
        const file = document.getElementById('comprovante-file').files[0];
        if(!file) return alert("Selecione o arquivo!");
        const name = `comp_${Date.now()}.jpg`;
        await _supabase.storage.from('playbacks').upload(name, file);
        const { data: pub } = _supabase.storage.from('playbacks').getPublicUrl(name);
        await _supabase.from('pedidos').insert([{ usuario: session.u, usuario_id: session.id.toString(), items: JSON.stringify(carrinho), comprovante_url: pub.publicUrl, status: 'pendente' }]);
        
        alert("Enviado com sucesso!"); 
        limparCarrinho();
        showPage('downloads', document.getElementById('tab-downloads'));
    }

    async function carregarPedidosAdmin() {
        const { data } = await _supabase.from('pedidos').select('*').eq('status', 'pendente');
        const lista = document.getElementById('corpo-tabela-admin'); lista.innerHTML = "";
        data?.forEach(p => {
            lista.innerHTML += `<tr><td>${p.usuario}</td><td><a href="${p.comprovante_url}" target="_blank" style="color:yellow; font-weight:bold;">VER FOTO</a></td><td><button onclick="aprovarPedido(${p.id})" style="background:green; color:white; padding:5px; border-radius:5px;">OK</button></td></tr>`;
        });
    }

    async function aprovarPedido(id) {
        await _supabase.from('pedidos').update({ status: 'aprovado' }).eq('id', id);
        alert("Aprovado!"); carregarPedidosAdmin();
    }

    function addCarrinho(id, nome, preco) {
        if(!session) return showPage('conta', document.getElementById('tab-conta'));
        carrinho.push({ id, nome, preco });
        localStorage.setItem('MP_CART', JSON.stringify(carrinho));
        updateCartUI(); startTimer(); showPage('carrinho', document.getElementById('tab-carrinho'));
    }

    function updateCartUI() {
        const info = document.getElementById('carrinho-info'), vazio = document.getElementById('carrinho-vazio'), lista = document.getElementById('lista-carrinho');
        if(carrinho.length > 0) {
            info.style.display = 'block'; vazio.style.display = 'none';
            lista.innerHTML = ""; let t = 0;
            carrinho.forEach(i => { t += i.preco; lista.innerHTML += `<div>‚ñ∫ ${i.nome} - R$ ${i.preco.toFixed(2)}</div>`; });
            document.getElementById('carrinho-total').innerText = "Total: R$ " + t.toFixed(2);
        } else { info.style.display = 'none'; vazio.style.display = 'block'; }
    }

    function limparCarrinho() { carrinho = []; localStorage.removeItem('MP_CART'); clearInterval(intervalTimer); updateCartUI(); }

    function startTimer() {
        clearInterval(intervalTimer); let tempo = 1800;
        intervalTimer = setInterval(() => {
            let m = Math.floor(tempo / 60), s = tempo % 60;
            if(document.getElementById('pix-timer')) document.getElementById('pix-timer').innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
            if (tempo-- <= 0) limparCarrinho();
        }, 1000);
    }

    async function gerarLink(inputId, outputId) {
        const file = document.getElementById(inputId).files[0];
        if (!file) return alert("Selecione um arquivo!");
        const ext = file.name.split('.').pop();
        const fileName = `${Date.now()}.${ext}`;
        try {
            const { data, error } = await _supabase.storage.from('playbacks').upload(fileName, file);
            if (error) throw error;
            const { data: res } = _supabase.storage.from('playbacks').getPublicUrl(fileName);
            document.getElementById(outputId).value = res.publicUrl;
            alert("URL Gerada com sucesso!");
        } catch (e) {
            alert("Erro ao subir: " + e.message);
        }
    }

    function showPage(p, btn) {
        document.querySelectorAll('.page').forEach(x => x.classList.remove('active'));
        document.getElementById('page-'+p).classList.add('active');
        if(btn) { document.querySelectorAll('.tab-btn').forEach(x => x.classList.remove('active')); btn.classList.add('active'); }
        if(p === 'downloads') renderDownloads();
    }

    function login() {
        const u = document.getElementById('log-u').value.trim();
        const p = document.getElementById('log-p').value.trim();
        if (!u || !p) return alert("Preencha tudo!");
        db.transaction("usuarios").objectStore("usuarios").get(u).onsuccess = e => {
            if(e.target.result?.p === p) { 
                localStorage.setItem('MP_SES', JSON.stringify(e.target.result)); 
                location.reload(); 
            } else { alert("Senha incorreta!"); }
        };
    }

    function register() {
        const u = document.getElementById('log-u').value.trim();
        const p = document.getElementById('log-p').value.trim();
        if (!u || !p) return alert("Preencha tudo!");
        const transaction = db.transaction(["usuarios"], "readwrite");
        const store = transaction.objectStore("usuarios");
        store.get(u).onsuccess = e => {
            if (e.target.result) { alert("Usu√°rio j√° existe!"); }
            else {
                const user = { u, p, id: Math.floor(1000 + Math.random() * 9000) };
                store.add(user).onsuccess = () => {
                    localStorage.setItem('MP_SES', JSON.stringify(user)); 
                    location.reload();
                };
            }
        };
    }

    function logout() { localStorage.removeItem('MP_SES'); location.reload(); }
    function copy(el) { el.select(); document.execCommand('copy'); alert("Copiado!"); }
    function accessAdmin() { if(prompt("Senha:") === "C626G7@#$") { showPage('admin'); carregarPedidosAdmin(); } }

    document.addEventListener('play', function(e){
        var audios = document.getElementsByTagName('audio');
        for(var i = 0, len = audios.length; i < len;i++){
            if(audios[i] != e.target){
                audios[i].pause();
                audios[i].currentTime = 0;
            }
        }
    }, true);

    // LOGICA DO BOT√ÉO INVIS√çVEL - 5 SEGUNDOS
    const bOculto = document.getElementById('meuBotaoAdmin');
    let timerOculto;

    function startH() {
        timerOculto = setTimeout(() => {
            accessAdmin();
        }, 5000); // Alterado para 5 Segundos
    }

    function stopH() {
        clearTimeout(timerOculto);
    }

    bOculto.addEventListener('mousedown', startH);
    bOculto.addEventListener('touchstart', startH);
    bOculto.addEventListener('mouseup', stopH);
    bOculto.addEventListener('mouseleave', stopH);
    bOculto.addEventListener('touchend', stopH);

</script>
</body>
</html>
